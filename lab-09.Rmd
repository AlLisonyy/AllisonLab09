---
title: "Lab 09: Algorithmic Bias"
author: "Allison Li"
date: "20250407"
output: github_document
---

## Load Packages and Data  

First, let's load the necessary packages:  

```{r load-packages, message = FALSE}
##install.packages('ggpubr')
##install.packages('janitor')

library(tidyverse)
library(fairness)
library(ggplot2)
library(janitor)
library(ggpubr)

```

### The data

For this lab, we'll use the COMPAS dataset compiled by ProPublica. The data has been preprocessed and cleaned for you. You'll have to load it yourself. The dataset is available in the `data` folder, but I've changed the file name from `compas-scores-two-years.csv` to `compas-scores-2-years.csv`. I've done this help you practice debugging code when you encounter an error.

```{r clean data}
compas <- read_csv("data/compas-scores-2-years.csv")%>%
  clean_names() %>% 
  rename(decile_score = decile_score_12,
         priors_count = priors_count_15)

# Take a look at the data
glimpse(compas)
```
## Exercise 1

The COMPAS dataset has `r nrow(compas)` variables and `r ncol(compas)` data/person. Each row in this dataset represents a person that was arrested, and each row represents the information collected about that person, mostly their demographic information and their prison or arrested information.

## Exercise 2

```{r repeated data}
## I will try to examine if all the columns are unique defendants by looking at the names, age, and sex variables. If there are two people with same names, age, and sex, I will take a further look and see if they are actually the same person or not.
repeated_people <- compas %>%
  group_by(name, sex, age) %>%  # dob = date of birth if available
  filter(n() > 1)
print(repeated_people)

## I only found two people with same age, sex, and names. After looking at their other information, such as DOB, I knew that they were not the same person. 
## So in general, there is no repeated data, so the number of unique defendants are the same as the number of rows.
```
## Exercise 3

```{r decile score distribution}
ggplot(compas, aes(x = decile_score)) +
  geom_histogram(binwidth = 1, color = "black", fill = "pink") +
  labs(
    title = "Distribution of COMPAS Risk Scores",
    x = "Decile Score",
    y = "Number of Defendants"
  ) 

```

According to the graph, the distribution is right skewed, suggesting that most people in the dataset have a low risk score. 

## Exercise 3

```{r demographic distribution}
## race
compas_race <- compas %>%
  mutate(
    race = case_when(
      race == "African-American" ~ 6,
      race == "Asian" ~ 5,
      race == "Caucasian" ~ 4,
      race == "Hispanic" ~ 3,
      race == "Native American" ~ 2,
      race == "Other" ~ 1
    )
  )

ggplot(compas_race, aes(x = race)) +
  geom_histogram(binwidth = 1, color = "orange", fill = "tomato") + ##tomato loll
  labs(
    title = "Distribution of Defendants' Race",
    x = "Race/Ethnicity",
    y = "Number of Defendants"
  ) 


## sex
compas_sex <- compas %>%
  mutate(
    sex = case_when(
      sex == "Male" ~ 2,
      sex == "Female" ~ 1
    )
  )

ggplot(compas_sex, aes(x = sex)) +
  geom_histogram(binwidth = 1, color = "lightblue", fill = "pink") + 
  labs(
    title = "Distribution of Defendants' Sex",
    x = "Sex",
    y = "Number of Defendants"
  ) 

## age
compas_age <- compas %>%
  mutate(
    age_cat = case_when(
      age_cat == "25 - 45" ~ 2,
      age_cat == "Greater than 45" ~ 3,
      age_cat == "Less than 25" ~ 1
    )
  )

ggplot(compas_age, aes(x = age_cat)) +
  geom_histogram(binwidth = 1, color = "yellow", fill = "lightgreen") +
  labs(
    title = "Distribution of Defendants' Age Period",
    x = "Age Category",
    y = "Number of Defendants"
  ) 


##extra challenge
compas_three <- compas %>%
  mutate(
    race = case_when(
      race == "African-American" ~ 6,
      race == "Asian" ~ 5,
      race == "Caucasian" ~ 4,
      race == "Hispanic" ~ 3,
      race == "Native American" ~ 2,
      race == "Other" ~ 1),
      sex = case_when(
      sex == "Male" ~ 2,
      sex == "Female" ~ 1),
    age_cat = case_when(
      age_cat == "25 - 45" ~ 2,
      age_cat == "Greater than 45" ~ 3,
      age_cat == "Less than 25" ~ 1
    ))

compas_three <- compas_three %>%
  select(race, sex, age_cat) %>%
  pivot_longer(cols = everything(), names_to = "demographic", values_to = "category") ##I asked GPT for help for this step.

ggplot(compas_three, aes(x = category, fill = demographic)) +
  geom_bar(position = "dodge", color = "yellow") +
  facet_wrap(~ demographic, scales = "free_x") +
  scale_fill_manual(values = c(
    "race" = "tomato",
    "sex" = "lightpink",
    "age_cat" = "lightgreen"
  )) +
  labs(
    title = "Demographic Distributions: Race, Sex, and Age Category",
    x = "",
    y = "Count"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Exercise 5

```{r correlation graph}
ggplot(compas, aes(x = decile_score, y = two_year_recid)) +
  geom_smooth(method = "lm", formula = y ~ x, color = "blue") +
  stat_cor(method = "pearson", label.x = 2, label.y = 1) +
  theme_bw() +
  labs(
    x = "Two-Year Recidivism (0 = No, 1 = Yes)",
    y = "Risk Scores",
    title = "Relationship Between Risk Scores and Actual Recidivism"
  )

```

According to the graph, it shows that there is a positive correlation between two year recidivism and risk scores. This relationship suggests that higher risk score is actually related with higher rates of recidivism.

## Exercise 6

```{r correct prediction}
compas_accuracy <- compas %>%
  mutate(
    correct_prediction = case_when(
      decile_score >= 7 & two_year_recid == 1 ~ 1,
      decile_score <= 4 & two_year_recid == 0 ~ 1,
      TRUE ~ 0
    )
  )

accuracy <- mean(compas_accuracy$correct_prediction)
print(paste("Overall accuracy of COMPAS:", round(accuracy * 100, 2), "%"))
```

## Exercise 7

According to the actual correlation and the prediction between the risk scores and actual recidivism, the relationship of the actual one is moderate and less strong than the prediction. The results suggest that while the COMPAS algorithm shows some predictive ability, it does not seem to align well with the actual correlation. 

# Part 3
## Exercise 8

```{r black and white defendants}

filtered_data <- compas %>%
  filter(race %in% c("African-American", "Caucasian"))

score_distribution <- filtered_data %>%
  group_by(race, decile_score) %>%
  summarise(count = n(), .groups = "drop")

ggplot(score_distribution, aes(x = decile_score, y = count, color = race)) +
  geom_line(size = 1) +
  geom_point(size = 1.2) +
  labs(
    title = "Relationship Between Risk Scores and Actual Recidivism",
    x = "Decile Score",
    y = "Number of Defendants",
    color = "Race"
  ) 

```

There is a notable difference between black and white defendants, that the line representing African-Americans was flatter, indicating that African-American individuals were identified as having higher risk scores more frequently than to white defendants. 

## Exercise 9

```{r}
highrisk_summary <- filtered_data %>%
  mutate(high_risk = decile_score >= 7) %>%
  group_by(race) %>%
  summarise(
    total = n(),
    high_risk_n = sum(high_risk),
    high_risk_percent = round(100 * mean(high_risk), 2)
  )
print(highrisk_summary)
```

According to the results, 38.56% of Black defendants were identified as high risk, while 17.07% of White defendants were identified as high risk, indicating that there is a more than twice larger disparity. 

## Exercise 10

```{r metrics}

##False Positive Rate
non_recidivists <- compas %>%
  filter(two_year_recid == 0)%>%
  filter(race %in% c("African-American", "Caucasian")) %>%
  mutate(high_risk = decile_score >= 7) %>%
  group_by(race) %>%
  summarise(
    total_non_recidivists = n(),
    false_positives = sum(high_risk),
    false_positive_rate = round(100 * mean(high_risk), 2)
  )

##False Negative Rate
recidivists <- compas %>%
  filter(two_year_recid == 1) %>%
  filter(race %in% c("African-American", "Caucasian")) %>%
  mutate(low_risk = decile_score <= 4) %>%
  group_by(race) %>%
  summarise(
    total_recidivists = n(),
    false_negatives = sum(low_risk),
    false_negative_rate = round(100 * mean(low_risk), 2)
  )

print(fpr)
print(fnr)

```

## Exercise 11

```{r}
fpr <- compas %>%
  filter(race %in% c("African-American", "Caucasian"), two_year_recid == 0) %>%
  mutate(high_risk = decile_score >= 7) %>%
  group_by(race) %>%
  summarise(rate = mean(high_risk), .groups = "drop") %>%
  mutate(metric = "False Positive Rate")
fnr <- compas %>%
  filter(race %in% c("African-American", "Caucasian"), two_year_recid == 1) %>%
  mutate(low_risk = decile_score <= 4) %>%
  group_by(race) %>%
  summarise(rate = mean(low_risk), .groups = "drop") %>%
  mutate(metric = "False Negative Rate")

metrics_df <- bind_rows(fpr, fnr)

metrics_df <- metrics_df %>%
  mutate(rate_percent = round(rate * 100, 2))

##The visualization
ggplot(metrics_df, aes(x = metric, y = rate_percent, fill = race)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Compare the metrics between Black and white defendants",
    x = "Metric",
    y = "Rate (%)",
    fill = "Race"
  ) +
  theme_minimal(base_size = 14) +
  geom_text(aes(label = paste0(rate_percent, "%")), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5)
```

According to the graph, it is clear that Caucasian has a high rate in false negative rate, suggesting that White defendants were more likely to be viewed as not a criminal when they actually committed a crime. This rate is low for Black individuals in the study. Additionally, the false negative rate is higher for African-American people, suggesting that Black defendants were more likely to be considered as a criminal when they in fact did not committed a crime. 

# Part 4
## Exercise 12

```{r}
filtered_data <- compas %>%
  filter(race %in% c("African-American", "Caucasian"))

ggplot(filtered_data, aes(x = priors_count, y = decile_score, color = race)) +
  geom_jitter(alpha = 0.4, width = 0.3, height = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, size = 1) +  
  labs(
    title = "Relationship Between Prior Convictions and COMPAS Risk Score by Race",
    x = "Number of Prior Convictions",
    y = "Risk Score (Decile)",
    color = "Race"
  ) 
```

In general, although both racial groups' correlations suggested that higher risk score was associated with more number of prior convictions, there is a small differences between the two racial groups. It seems that with same amount of convictions, black people were identified as having higher risk scores than white, but the difference is small and seemed to disappear when the number of convictions is higher.

## Exercise 13

Based on the previous analyses, I think in terms of the error rates (false positive and false negative), there is a bias in the algorithm, indicating that Black individuals in the dataset are more likely to be considered as criminals when they are actually not. In terms of calibration, the algorithm tends to view Black individuals having higher risk scores when White and Black individuals committeed the same amount of crime. However, this difference became smaller and changed to the opposite when the number of prior convictions become around 23. In general, I think the algorithm is biased (if I understand the questions and analyses correctly).

# Part 5
## Exercise 14
I would first control for the race/ethnicity of the individuals in the dataset while creating the algorithm. More specifically, I would try to equalize the false positive and false negative rates across racial and gender groups. I would minimize racial disparities by ensuring that the algorithm does not produce systematically higher scores for one group over another. Additionally, to make it more fair, I would take the degree of crime into account when creating the algorithm. For example, the number of juvenile felonies should be weighted more heavily than the  number of juvenile misdemeanors.

## Exercise 15

